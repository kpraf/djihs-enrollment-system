<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Key Teacher | Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
      <link rel="icon" type="image/png" href="../assets/favicons/favicon-96x96.png" sizes="96x96" />
      <link rel="icon" type="image/svg+xml" href="../assets/favicons/favicon.svg" />
      <link rel="shortcut icon" href="../assets/favicons/favicon.ico" />
      <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicons/apple-touch-icon.png" />
      <meta name="apple-mobile-web-app-title" content="DJIHS" />
      <link rel="manifest" href="../assets/favicons/site.webmanifest" />


    <!-- AUTHENTICATION PROTECTION -->
    <script src="../js/auth.js"></script>
    <script>
        (function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userDataString = localStorage.getItem('user');
            
            if (!isLoggedIn || !userDataString) {
                window.location.href = '../login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userDataString);
                if (user.Role !== 'Key_Teacher') {
                    alert('Access denied. Key Teacher access required.');
                    window.location.href = '../login.html';
                }
            } catch (e) {
                window.location.href = '../login.html';
            }
        })();
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#085019",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "success": "#28A745",
                        "warning": "#FFC107",
                        "danger": "#DC3545",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex h-auto min-h-screen w-full">
        <div class="flex min-h-screen w-full">
            <!-- Sidebar -->
            <aside class="w-72 h-screen sticky top-0 bg-white dark:bg-card-dark border-r border-gray-200 dark:border-gray-700 flex flex-col justify-between hidden md:flex transition-colors duration-200">
                <div>
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-1">
                            <div class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900 flex items-center justify-center overflow-hidden shrink-0 border border-yellow-200">
                                <img alt="School Logo" class="w-full h-full object-cover opacity-90" src="../assets/images/djihs-logo-small.png"/>
                            </div>
                        </div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight mt-3">DJIHS Key Teacher</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Don Jose Integrated High School</p>
                    </div>
                    <nav class="px-4 space-y-1">
                        <a class="flex items-center gap-3 px-4 py-3 bg-primary text-white rounded-lg shadow-sm" href="dashboard.html">
                            <span class="material-icons-outlined text-[20px]">dashboard</span>
                            <span class="text-sm font-medium">Dashboard</span>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" href="manage-sections.html">
                            <span class="material-icons-outlined text-[20px]">view_quilt</span>
                            <span class="text-sm font-medium">Manage Sections</span>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" href="assign-students.html">
                            <span class="material-icons-outlined text-[20px]">group_add</span>
                            <span class="text-sm font-medium">Assign Students</span>
                        </a>
                        <!-- 
                        <a class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" href="settings.html">
                            <span class="material-icons-outlined text-[20px]">settings</span>
                            <span class="text-sm font-medium">Settings</span>
                        </a>
                        -->
                    </nav>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 mb-4 px-2">
                        <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-primary dark:text-green-300 font-bold text-sm" id="userInitials">KT</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate" id="userName">Key Teacher</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Key Teacher</p>
                        </div>
                    </div>
                    <button class="w-full flex items-center gap-2 px-2 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors logout-btn">
                        <span class="material-icons-outlined text-[18px]">logout</span>
                        Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <main class="flex-1 p-6 lg:p-8">
                    <div class="flex flex-wrap justify-between gap-4 items-end mb-6">
                        <div class="flex min-w-72 flex-col gap-1">
                            <p class="text-gray-800 dark:text-gray-100 text-3xl font-bold leading-tight">Dashboard</p>
                            <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">
                                Welcome back! Here's your dashboard overview.
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Academic Year:</label>
                                <select id="yearFilter" onchange="changeAcademicYear()" class="px-8 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <a href="manage-sections.html" class="flex items-center justify-center gap-2 px-6 h-10 rounded-lg bg-primary text-white text-sm font-bold hover:bg-primary/90">
                                <span class="material-symbols-outlined text-lg">add</span>
                                <span>Manage Section</span>
                            </a>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                            <p class="text-gray-600 dark:text-gray-300 text-base font-medium leading-normal">Total Enrolled Students</p>
                            <p class="text-gray-800 dark:text-white tracking-light text-3xl font-bold leading-tight" id="totalEnrolled">
                                <span class="inline-block animate-pulse bg-gray-300 dark:bg-gray-600 rounded w-16 h-8"></span>
                            </p>
                        </div>
                        <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                            <p class="text-gray-600 dark:text-gray-300 text-base font-medium leading-normal">Total Sections</p>
                            <p class="text-gray-800 dark:text-white tracking-light text-3xl font-bold leading-tight" id="totalSections">
                                <span class="inline-block animate-pulse bg-gray-300 dark:bg-gray-600 rounded w-16 h-8"></span>
                            </p>
                        </div>
                        <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                            <p class="text-gray-600 dark:text-gray-300 text-base font-medium leading-normal">Average Fill Rate</p>
                            <p class="text-gray-800 dark:text-white tracking-light text-3xl font-bold leading-tight" id="avgFillRate">
                                <span class="inline-block animate-pulse bg-gray-300 dark:bg-gray-600 rounded w-16 h-8"></span>
                            </p>
                        </div>
                        <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                            <p class="text-gray-600 dark:text-gray-300 text-base font-medium leading-normal">Unassigned Students</p>
                            <p class="text-gray-800 dark:text-white tracking-light text-3xl font-bold leading-tight" id="unassignedStudents">
                                <span class="inline-block animate-pulse bg-gray-300 dark:bg-gray-600 rounded w-16 h-8"></span>
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Section Overview -->
                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-gray-800 dark:text-white text-xl font-bold leading-tight">Section Overview</h2>
                                <div class="relative w-full max-w-xs">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <span class="material-symbols-outlined text-gray-400">search</span>
                                    </div>
                                    <input id="searchInput" oninput="searchSections()" class="block w-full rounded-lg border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 pr-4 py-2 text-sm text-gray-800 dark:text-gray-200 focus:ring-primary focus:border-primary" placeholder="Find a section..." type="text"/>
                                </div>
                            </div>
                            <div id="sectionsList" class="space-y-4">
                                <!-- Loading state -->
                                <div class="animate-pulse space-y-4">
                                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 h-24"></div>
                                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 h-24"></div>
                                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 h-24"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Required -->
                        <div class="lg:col-span-1">
                            <h2 class="text-gray-800 dark:text-white text-xl font-bold leading-tight mb-4">Action Required</h2>
                            <div id="alertsList" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 space-y-4">
                                <!-- Loading state -->
                                <div class="animate-pulse space-y-4">
                                    <div class="flex gap-3">
                                        <div class="flex-shrink-0 size-8 rounded-full bg-gray-300 dark:bg-gray-600"></div>
                                        <div class="flex-1 space-y-2">
                                            <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4"></div>
                                            <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-full"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allSections = [];
        let currentAcademicYear = null;

        document.addEventListener('DOMContentLoaded', function() {
            currentUser = JSON.parse(localStorage.getItem('user'));
            displayUserInfo();
            setupEventListeners();
            loadSchoolYears();
        });

        function displayUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = `${currentUser.FirstName} ${currentUser.LastName}`;
                document.getElementById('userInitials').textContent = `${currentUser.FirstName[0]}${currentUser.LastName[0]}`;
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.logout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('user');
                        window.location.href = '../login.html';
                    }
                });
            });
        }

        async function loadSchoolYears() {
            try {
                const response = await fetch('../backend/api/get-school-years.php');
                const data = await response.json();
                
                if (data.success && data.schoolYears.length > 0) {
                    const yearFilter = document.getElementById('yearFilter');
                    yearFilter.innerHTML = '';
                    
                    data.schoolYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = `S.Y. ${year}`;
                        yearFilter.appendChild(option);
                    });
                    
                    // Set to first year (most recent) and load data
                    currentAcademicYear = data.schoolYears[0];
                    yearFilter.value = currentAcademicYear;
                    loadDashboardData();
                } else {
                    // No years found, still try to load data
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Error loading school years:', error);
                // Still try to load data even if years fail
                loadDashboardData();
            }
        }

        function changeAcademicYear() {
            currentAcademicYear = document.getElementById('yearFilter').value;
            loadDashboardData();
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadOverview(),
                    loadSections(),
                    loadAlerts()
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadOverview() {
            try {
                const url = currentAcademicYear 
                    ? `../backend/api/key-teacher-dashboard.php?action=overview&year=${currentAcademicYear}`
                    : '../backend/api/key-teacher-dashboard.php?action=overview';
                    
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    currentAcademicYear = data.data.academicYear;
                    document.getElementById('totalEnrolled').textContent = data.data.totalEnrolled;
                    document.getElementById('totalSections').textContent = data.data.totalSections;
                    document.getElementById('avgFillRate').textContent = data.data.avgFillRate + '%';
                    document.getElementById('unassignedStudents').textContent = data.data.unassignedStudents;

                    // Highlight unassigned students if > 0
                    const unassignedEl = document.getElementById('unassignedStudents');
                    if (data.data.unassignedStudents > 0) {
                        unassignedEl.classList.add('text-warning');
                    } else {
                        unassignedEl.classList.remove('text-warning');
                    }
                }
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        async function loadSections() {
            try {
                const url = currentAcademicYear 
                    ? `../backend/api/key-teacher-dashboard.php?action=sections&year=${currentAcademicYear}`
                    : '../backend/api/key-teacher-dashboard.php?action=sections';
                    
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    allSections = data.sections;
                    renderSections(allSections);
                }
            } catch (error) {
                console.error('Error loading sections:', error);
            }
        }

        function renderSections(sections) {
            const container = document.getElementById('sectionsList');

            if (sections.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No sections found</p>';
                return;
            }

            container.innerHTML = sections.map(section => {
                const statusColors = {
                    'Full': 'bg-danger text-white',
                    'Nearing Capacity': 'bg-warning text-yellow-800',
                    'Open': 'bg-success text-white'
                };

                const progressColors = {
                    'Full': 'bg-danger',
                    'Nearing Capacity': 'bg-warning',
                    'Open': 'bg-success'
                };

                return `
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-4">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-gray-800 dark:text-white">${section.SectionName}</h3>
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">${section.CurrentEnrollment} / ${section.Capacity} Students</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="${progressColors[section.Status]} h-2 rounded-full" style="width: ${section.FillPercentage}%"></div>
                            </div>
                            ${section.AdviserName ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Adviser: ${section.AdviserName}</p>` : ''}
                        </div>
                        <span class="text-xs font-bold py-1 px-3 rounded-full ${statusColors[section.Status]}">${section.Status}</span>
                    </div>
                `;
            }).join('');
        }

        async function loadAlerts() {
            try {
                const url = currentAcademicYear 
                    ? `../backend/api/key-teacher-dashboard.php?action=alerts&year=${currentAcademicYear}`
                    : '../backend/api/key-teacher-dashboard.php?action=alerts';
                    
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderAlerts(data.alerts);
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alertsList');

            const colorMap = {
                'warning': { bg: 'bg-warning/20', text: 'text-yellow-600 dark:text-yellow-400' },
                'danger': { bg: 'bg-danger/20', text: 'text-danger' },
                'info': { bg: 'bg-primary/20', text: 'text-primary' },
                'success': { bg: 'bg-success/20', text: 'text-success' }
            };

            container.innerHTML = alerts.map(alert => {
                const colors = colorMap[alert.type];
                return `
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 size-8 rounded-full ${colors.bg} ${colors.text} flex items-center justify-center">
                            <span class="material-symbols-outlined text-lg">${alert.icon}</span>
                        </div>
                        <div>
                            <p class="font-medium text-sm text-gray-800 dark:text-gray-200">${alert.title}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${alert.description}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchSections() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderSections(allSections);
                return;
            }

            const filtered = allSections.filter(section => 
                section.SectionName.toLowerCase().includes(searchTerm) ||
                (section.AdviserName && section.AdviserName.toLowerCase().includes(searchTerm))
            );

            renderSections(filtered);
        }
    </script>
</body>
</html>